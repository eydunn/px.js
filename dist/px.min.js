/*! px - v0.1.0 - 2012-08-05
* https://github.com/fod/px.js
* Copyright (c) 2012 Fiachra O'Donoghue; Licensed MIT */
(function(){"use strict";var a=this,b=function(){function a(a){this.ctor(a)}function b(a){var b=[];while(a--)b[a]=0;return b}return a.prototype={keyword:function(a){if(!_.include(this.keywords(),a))throw"'"+a+"' is not a valid KEYWORD";return this.metadata[a].TABLE?this.metadata[a].TABLE:this.metadata[a]},title:function(){return this.keyword("TITLE")},keywords:function(){return _.keys(this.metadata)},variables:function(){return _.flatten([this.keyword("STUB"),this.keyword("HEADING")])},variable:function(a){var b=this.variables();return typeof a=="number"?b[a]:typeof a=="string"?_.indexOf(b,a):_.isRegExp(a)?_.indexOf(b,_.find(b,function(b){return b.match(a)})):undefined},values:function(a){var b=typeof a=="number"?this.variable(a):this.variables()[this.variable(a)];return this.keyword("VALUES")[b]},codes:function(a){var b=typeof a=="number"?this.variable(a):this.variables()[this.variable(a)];return this.keyword("CODES")[b]},valCounts:function(){var a=[];return _.each(this.variables(),function(b,c){a.push(_.size(this.values(c)))},this),a},value:function(){},code:function(){},datum:function(a){var b=this.valCounts(),c=0;for(var d=0,e=a.length-1;d<e;d++)c+=a[d]*_.reduce(b.slice(d+1),function(a,b){return a*b});return c+=_.last(a),arguments[1]===!0?c:+this.data[c]},datacol:function(a){var b=this.valCounts(),c=[],d=_.indexOf(a,"*");for(var e=0;e<b[d];e++)a[d]=e,c.push(this.datum(a,arguments[1]));return c},datadict:function(a){var b={},c=_.indexOf(a,"*"),d=this.codes(c),e=this.datacol(a);return _.each(e,function(a,c){b[d[c]]=a}),b},datatable:function(a){var b=this.valCounts(),c=[];_.each(a,function(a,b){a==="*"&&c.push(b)});var d=c[0],e=_.last(c),f=[];for(var g=0;g<b[e];g++)a[d]="*",a[e]=g,console.log(a),f.push(this.datacol(a,arguments[1]));return f},explicitDatatable:function(){var a=this.valCounts(),c=this.variables(),d=b(a.length),e=d.length-1,f=[],g=[];for(var h=0,i=a.length;h<i-1;h++)f[h]=_.reduce(a.slice(h+1),function(a,b){return a*b});return _.each(this.data,function(b,h){var i={num:b};for(var j=0,k=c.length;j<k;j++)i[c[j]]=this.values(j)[d[j]];g.push(i);for(var l=0,m=f.length;l<m;l++)(h+1)%f[l]===0&&(d[l]=d[l]===a[l]-1?0:d[l]+1);d[e]=d[e]===a[e]-1?0:d[e]+1},this),g},truncate:function(a){var c=this.valCounts(),d=[];_.each(a,function(b,d){b[0]==="*"&&(a[d]=_.range(0,c[d]-1))});for(var e=0,f=c.length;e<f-1;e++)d[e]=_.reduce(c.slice(e+1),function(a,b){return a*b});d.push(1);for(var g=0,h=a.length;g<h;g++)this.metadata.VALUES[this.variables()[g]]=_.filter(this.metadata.VALUES[this.variables()[g]],function(b,c){return _.indexOf(a[g],c)!==-1});var i=[],j=function l(a,c,d,e){if(a.length>1){e=typeof e!="undefined"?e:1;var f=a.pop(),g=c.pop(),h=d.pop(),j=_.flatten(_.map(_.range(0,f),function(a){return _.include(h,a)?e:b(g)}));l(a,c,d,j)}i.push(_.flatten(e))};j(c,d,a),i=i[0];var k=[];_.each(a[0],function(a){var b=a*d[0],c=b+d[0];k.push(_.filter(_.range(b,c),function(a,b){return i[b]===1}))}),k=_.flatten(k),this.data=_.filter(this.data,function(a,b){return _.indexOf(k,b)!==-1})},subset:function(a){},ctor:function(a){var b={},c,d=a.split(/\nDATA=/),e=d[0].replace(/;\s*(\r\n?|\n)/g,";;").replace(/;;$/,";").replace(/(\r\n?|\n)/g,"").replace(/""/g," ").split(";;"),f=d[1];for(var g=0,h=e.length;g<h;g++){var i=e[g].match(/^(.+?)(?:\((.+?)\))?=(.+)$/);i[2]||(i[2]="TABLE");var j=i[1],k=i[3].replace(/^"|"$/g,"").split(/","/g),l=i[2].replace(/"/g,"");b[j]||(b[j]={}),j!=="VALUES"?b[j][l]=k.length===1?k[0]:k:b[j][l]=k}c=f.replace(/(\r\n|\r|\n)/g,"").replace(/;\s*/,"").split(/\s+/),b.HEADING||(b.HEADING={TABLE:[]}),this.metadata=b,this.data=c}},a}();typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=b),a._=require("underscore"),exports.Px=b):a.Px=b}).call(this);